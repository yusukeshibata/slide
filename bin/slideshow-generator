#!/usr/bin/env node

var path = require('path')
var fs = require('fs')
var jade = require('jade')
var argv = require('minimist')(process.argv.slice(2));
var marked = require('marked')
var async = require('async')
var request = require('request')
var fm = require('front-matter')
var _ = require('lodash')
var DataUri = require('datauri')
var connect  = require('connect')
var livereload = require('livereload')
var striptags = require('striptags')

var build = function(body,input,opt,callback) {
	if(!opt) opt = {}
	var content = fm(body)
	var tokens = marked.lexer(content.body,{
		gfm: true,
		tables: true,
		breaks: true,
		pedantic: true,
		sanitize: true,
		smartLists: true,
		smartypants: true
	})
	var titletoken
	var pages = []
	tokens.forEach(function(token) {
		if(token.type==='heading' || pages.length === 0) {
			pages.push({
				tokens:[]
			})
		}
		if(!titletoken) {
			titletoken = token
		}
		pages[pages.length-1].tokens.push(token)
	})
	async.each(pages,function(page,callback) {
		async.waterfall([
			// get resources
			function(callback) {
				if(opt.online) {
					callback(null,{})
					return
				}
				var dataqueue = {}
				var test = new marked.Renderer()
				test.image = function(href,title,text) {
					var check = href.match(/(^https?:)?.*(\.[^\.\?]+)(\?.+)?$/)
					dataqueue[href] = {
						remote:!!check[1],
						ext:check[2],
						url:check[1] ? href : path.resolve(input.dir,href)
					}
				}
				var tokens = _.cloneDeep(page.tokens)
				tokens.links = {}
				marked.parser(tokens,{ renderer:test })
				async.each(Object.keys(dataqueue),function(key,callback) {
					var data = dataqueue[key]
					if(data.remote) {
						request({
							uri:data.url,
							encoding: null
						},function(err,res,body) {
							var datauri = new DataUri()
							datauri.format(data.ext, body)
							dataqueue[key] = datauri.content
							callback()
						})
					} else {
						DataUri.promise(data.url)
							.then(function(content) {
								dataqueue[key] = content
								callback()
							})
							.catch(function(err) {
								callback(err)
							})
					}
				},function(err) {
					callback(err,dataqueue)
				})
			},
			// generate html
			function(dataqueue,callback) {
				var renderer = new marked.Renderer()
				renderer.image = function(href,title,text) {
					var content = opt.online ? href : dataqueue[href]
					return `<img src="${content}" alt="${text}"/>`
				}
				tokens = _.cloneDeep(page.tokens)
				tokens.links = {}
				var html = marked.parser(tokens,{ renderer:renderer })
				var titletokens = [titletoken]
				titletokens.links = {}
				title = striptags(marked.parser(titletokens,{ renderer:renderer }))
				delete page.tokens
				page.html = html
				callback()
			},
		],function(err) {
			callback(err)
		})
	},function(err) {
		callback(err,{
			attributes:content.attributes,
			title:title,
			pages:pages
		})
	})
}

var url = argv._[0]
if(!url) {
	console.error('File is not specified.')
	return
}
if(argv.watch) {
	var input = path.parse(url)
	var server = connect()
	var watcher = livereload.createServer({
		exts:[input.ext.substr(1)]
	})
	server.use(function(req,res) {
		if(req.url!=='/') {
			res.end()
			return
		}
		console.log('reloading:',url)
		fs.readFile(url,'utf8',function(err,body) {
			if(err) {
				res.end(err)
				return
			}
			build(body,input,argv,function(err,data) {
				var fn = jade.compileFile(__dirname+'/../src/index.jade')
				res.end(fn({
					watcher:watcher,
					data:JSON.stringify(data),
					process:process
				}))
			})
		})
	})
	var port = argv.port||argv.p||8080
	server.listen(port)
	watcher.watch(input.dir)
	console.log('Started:http://localhost:'+port+', Watching:',url)
	return
}

async.waterfall([
	// filepath
	function(callback) {
		if(url.match(/^https?:/)) {
			var filename = url.split('/').filter(function(c) {
				return c.length
			}).pop()
			var input = path.parse(filename)
			request(url,function(err,res,body) {
				callback(err,body,input)
			})
		} else {
			var input = path.parse(url)
			fs.readFile(url,'utf8',function(err,body) {
				callback(err,body,input)
			})
		}
	},
	//
	function(body,input,callback) {
		build(body,input,argv,function(err,data) {
			callback(err,data,input)
		})
	},
	function(data,input,callback) {
		var output = argv.output || argv.o || path.resolve(input.dir,input.name+'.html')
		var fn = jade.compileFile(__dirname+'/../src/index.jade')
		var html = fn({
			data:JSON.stringify(data),
			process:process
		})
		fs.writeFile(output,html,function(err) {
			callback(err,output)
		})
	},
],function(err,output) {
	if(err) {
		console.error(err)
		return
	}
	console.log('Output:',output)
})

